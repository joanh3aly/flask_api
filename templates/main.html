<html>

<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>

  <pre id="info"></pre>
  <div id="description"></div>
  <div>
    <button id="showCreateButton" onclick="showCreate()">Create</button>
    <!-- <button id="showCreateButton">Create</button> -->
  </div>

  <div>
    <table class="table" id="bookTable">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Author</th>
        <th>DatePosted</th>
        <th>Update</th>
        <th>Delete</th>
        <th>Tweets</th>
      </tr>
    </table>
  </div>

  <div>
    <table class="table" id="tweetsTable">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Author</th>
        <th>DatePosted</th>
        <th>TweetContent</th>
      </tr>
    </table>
  </div>

  <div id='createUpdateForm' style="display: none">
    <h2><span id="createLabel">Create a</span> <span id="updateLabel">update</span> Book</h2>
    <input type="hidden" name="id" /> <br />
    Title <input type="text" name="title" /> <br />
    Author <input type="text" name="author" /> <br />
    Date Posted <input type="text" name="dateposted" /> <br />
    <span><button id="doCreateButton" onclick="doCreate()">Create</button></span>
    <span><button id="doUpdateButton" onclick="doUpdate()">Update</button></span>
  </div>

  <script>
    function showCreate() {
      document.getElementById('showCreateButton').style.display = "none"
      document.getElementById('bookTable').style.display = "none"
      document.getElementById('createUpdateForm').style.display = "block"
      document.getElementById('createLabel').style.display = "inline"
      document.getElementById('updateLabel').style.display = "none"
      document.getElementById('doCreateButton').style.display = "block"
      document.getElementById('doUpdateButton').style.display = "none"
    }

    function clearForm() {
      var form = document.getElementById('createUpdateForm')
      form.querySelector('input[name="author"]').disabled = false
      form.querySelector('input[name="title"]').value = ''
      form.querySelector('input[name="dateposted"]').value = ''
    }

    function getBookFromRow(rowElement) {
      var book = {}
      book.id = rowElement.getAttribute('id')
      book.title = rowElement.cells[1].firstChild.textContent
      book.author = rowElement.cells[2].firstChild.textContent
      book.dateposted = rowElement.cells[3].firstChild.textContent
      return book
    }

    function populateFormWithBook(book) {
      var form = document.getElementById('createUpdateForm')
      form.querySelector('input[name="id"]').value = book.id
      form.querySelector('input[name="title"]').value = book.title
      form.querySelector('input[name="author"]').value = book.author
      form.querySelector('input[name="dateposted"]').value = book.dateposted
      return book
    }

    function getBookFromForm() {
      var form = document.getElementById('createUpdateForm')
      var book = {}
      book.id = form.querySelector('input[name="id"]').value
      book.title = form.querySelector('input[name="title"]').value
      book.author = form.querySelector('input[name="author"]').value
      book.dateposted = form.querySelector('input[name="dateposted"]').value
      console.log(JSON.stringify(book))
      return book
    }

    function showUpdate(buttonElement) {
      document.getElementById('showCreateButton').style.display = "none"
      document.getElementById('bookTable').style.display = "none"
      document.getElementById('createUpdateForm').style.display = "block"
      document.getElementById('createLabel').style.display = "none"
      document.getElementById('updateLabel').style.display = "none"
      document.getElementById('doCreateButton').style.display = "none"
      document.getElementById('doUpdateButton').style.display = "block"

      var rowElement = buttonElement.parentNode.parentNode
      var book = getBookFromRow(rowElement)
      populateFormWithBook(book)
    }

    function setBookInRow(rowElement, book) {
      rowElement.cells[0].firstChild.textContent = book.id
      rowElement.cells[1].firstChild.textContent = book.title
      rowElement.cells[2].firstChild.textContent = book.author
      rowElement.cells[3].firstChild.textContent = book.price
    }

    function doCreate() {
      var form = document.getElementById('createUpdateForm')
      var book = {}
      // book.id = form.querySelector('input[name="id"]').value
      book.title = form.querySelector('input[name="title"]').value
      book.author = form.querySelector('input[name="author"]').value
      book.dateposted = form.querySelector('input[name="dateposted"]').value
      createBookAjax(book)
    }

    function doUpdate() {
      var book = getBookFromForm()
      var rowElement = document.getElementById(book.id)
      updateBookAjax(book)
      setBookInRow(rowElement, book)
      clearForm()
      showViewAll()
    }

    function doDelete(r) {
      var tableElement = document.getElementById('bookTable');
      var rowElement = r.parentNode.parentNode;
      var index = rowElement.rowIndex;
      deleteBookAjax(rowElement.getAttribute("id"));
      tableElement.deleteRow(index);
    }

    function doTweets(r) {
      document.getElementById('showCreateButton').style.display = "none"
      document.getElementById('bookTable').style.display = "none"
      document.getElementById('createUpdateForm').style.display = "none"
      document.getElementById('createLabel').style.display = "none"
      document.getElementById('updateLabel').style.display = "none"
      document.getElementById('doCreateButton').style.display = "none"
      document.getElementById('doUpdateButton').style.display = "none"

      var tableElement = document.getElementById('bookTable');
      var rowElement = r.parentNode.parentNode;
      var index = rowElement.rowIndex;
      console.log('index', rowElement.getAttribute("id"))
      getTweetsAjax(rowElement.getAttribute("id"));
      getAllTweetsAjax()   
    }

    function showViewAll() {
      document.getElementById('showCreateButton').style.display = "block"
      document.getElementById('bookTable').style.display = "block"
      document.getElementById('tweetsTable').style.display = "none"
      document.getElementById('createUpdateForm').style.display = "none"
    }

    function addBookToTable(book) {
      // console.log('addBookToTable ', book.dateposted)
      var tableElement = document.getElementById('bookTable')
      var rowElement = tableElement.insertRow(-1)
      rowElement.setAttribute('ID', book.id)
      var cell1 = rowElement.insertCell(0);
      cell1.innerHTML = book.id
      var cell2 = rowElement.insertCell(1);
      cell2.innerHTML = book.title
      var cell3 = rowElement.insertCell(2);
      cell3.innerHTML = book.author
      var cell4 = rowElement.insertCell(3);
      cell4.innerHTML = book.dateposted
      // console.log('cell4.innerHTML ', cell4.innerHTML)
      var cell5 = rowElement.insertCell(4);
      cell5.innerHTML = '<button onclick="showUpdate(this)">Update</button>'
      var cell6 = rowElement.insertCell(5);
      cell6.innerHTML = '<button onclick=doDelete(this)>Delete</button>'
      var cell7 = rowElement.insertCell(6);
      cell7.innerHTML = '<button onclick=doTweets(this)>Find tweets</button>'
    }

    function addTweetsToTable(tweet) {
      // console.log('addBookToTable ', book.dateposted)
      var tableElement = document.getElementById('tweetsTable')
      var rowElement = tableElement.insertRow(-1)
      rowElement.setAttribute('ID', tweet.id)
      var cell1 = rowElement.insertCell(0);
      cell1.innerHTML = tweet.id
      var cell2 = rowElement.insertCell(1);
      cell2.innerHTML = tweet.title
      var cell3 = rowElement.insertCell(2);
      cell3.innerHTML = tweet.author
      var cell4 = rowElement.insertCell(3);
      cell4.innerHTML = tweet.dateposted
      // console.log('cell4.innerHTML ', cell4.innerHTML)
      var cell5 = rowElement.insertCell(4);
      cell5.innerHTML = tweet.tweetcontent
    }
  </script>
  <script src="/static/jquery-3.4.1.js"></script>
  <script>
    /* Set host variable for remote server */
    host = window.location.origin
    console.log('my host ', host)

    function createBookAjax(book) {
      console.log('createBookAjax', JSON.stringify(book));
      $.ajax({
        url: host+"/api/books",
        method: "POST",
        data: JSON.stringify(book),
        dataType: "JSON",
        contentType: "application/json; charset=utf-8",
        success: function (result) {
          console.log('create book id ', result);
          console.log(typeof book);
          book.id = result
          console.log('success book', JSON.stringify(book));
          addBookToTable(book)
          // getBooksAjax()
          clearForm()
          showViewAll()
        },
        error: function (xhr, status, error) {
          console.log("createBookAjax - error: " + status + " msg:" + error);
        }
      });
    }

    function getBooksAjax() {
      console.log('getBooksAjax');
      $.ajax({
        url: host+'/api/books',
        method: "GET",
        success: function (data) {
          for (key in data) {
            addBookToTable(data[key]);
            showViewAll()
          }
        },
        error: function (xhr, status, error) {
          console.log("getBooksAjax - error: " + status + " msg:" + error);
        }
      });
    }

    function updateBookAjax(book) {
      console.log('updateBookAjax ', JSON.stringify(book));
      $.ajax({
        "url": host+"/api/books/" + encodeURI(book.id),
        "method": "PUT",
        "data": JSON.stringify(book),
        "dataType": "JSON",
        contentType: "application/json; charset=utf-8",
        "success": function (result) {
          getBooksAjax()
          // console.log('success book', JSON.stringify(book));
          // addBookToTable(book)   
        },
        "error": function (xhr, status, error) {
          console.log("updateBookAjax - error: " + status + " msg:" + error);
        }
      });
    }

    function deleteBookAjax(id) {
      console.log(JSON.stringify('deleteBookAjax '+id));
      $.ajax({
        "url": host+"/api/books/" + encodeURI(id),
        "method": "DELETE",
        "data": "",
        "dataType": "JSON",
        contentType: "application/json; charset=utf-8",
        "success": function (result) {
          console.log(result);

        },
        "error": function (xhr, status, error) {
          console.log("deleteBookAjax - error: " + status + " msg:" + error);
        }
      });
    }

    function getTweetsAjax(id) {
      console.log('getTweetsAjax ', id);
      $.ajax({
        "url": host+"/api/tweets/" + encodeURI(id),
        "method": "GET",
        "data": "",
        "dataType": "JSON",
        contentType: "application/json; charset=utf-8",
        "success": function (result) {
          console.log('ajax tweets', result);

        },
        "error": function (xhr, status, error) {
          console.log("getTweetsAjax - error: " + status + " msg:" + error);
        }
      });
    }

    function getAllTweetsAjax() {
      console.log('getAllTweetsAjax ', id)
      $.ajax({
        url: host+'/api/tweets',
        method: "GET",
        success: function (data) {
          console.log(data)
          for (key in data) {
            addTweetsToTable(data[key]);
            // console.log(data[key])
          }
        },
        "error": function (xhr, status, error) {
          console.log("getAllTweetsAjax - error: " + status + " msg:" + error);
        }
      });
    }


    $(function () {
      getBooksAjax()
      // getAllTweetsAjax()
    })
  </script>

  <!-- <script src="/static/math.js?r={{reload}}"></script> -->
  <!-- <script type="text/javascript" src="{{ url_for('static', filename='math.js') }}"></script> -->
</body>

</html>